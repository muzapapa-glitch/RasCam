# Changelog - Функция настройки чувствительности детектора движения

## Версия: 1.1.0 - Добавлена функция настройки чувствительности

Дата: 2026-02-16

### Новые возможности

#### 1. Настройка чувствительности детектора движения (motion_detector.py)

**Добавленные методы:**

- `set_sensitivity(sensitivity: str)` - Установка предустановленного уровня чувствительности
  - Доступные уровни: 'low', 'medium', 'high', 'very_high'
  - Автоматическое преобразование в соответствующие значения threshold

- `get_sensitivity_level()` - Получение текущего уровня чувствительности
  - Возвращает строковое представление текущего уровня на основе threshold

- Расширение `get_motion_state()` - Добавлено поле 'sensitivity' в возвращаемый словарь

**Предустановленные уровни чувствительности:**
```python
'low': 15.0        # Только крупные объекты
'medium': 7.0      # Баланс (по умолчанию)
'high': 4.0        # Чувствительный к мелким движениям
'very_high': 2.0   # Максимальная чувствительность
```

#### 2. API endpoints для веб-интерфейса (web_interface/app.py)

**Новые endpoints:**

- `GET /api/motion/sensitivity` - Получить текущую чувствительность
  ```json
  {
    "sensitivity": "medium",
    "threshold": 7.0
  }
  ```

- `POST /api/motion/sensitivity` - Установить предустановленный уровень
  ```json
  // Request
  {"sensitivity": "high"}

  // Response
  {
    "success": true,
    "sensitivity": "high",
    "threshold": 4.0
  }
  ```

- `POST /api/motion/threshold` - Установить точное значение порога (0-50)
  ```json
  // Request
  {"threshold": 5.5}

  // Response
  {
    "success": true,
    "threshold": 5.5,
    "sensitivity": "high"
  }
  ```

**Вспомогательные функции:**
- `_save_motion_config()` - Автоматическое сохранение настроек в config.json

#### 3. UI элементы в веб-интерфейсе (web_interface/templates/index.html)

**Добавленная панель управления:**

- Отображение текущего порога и уровня чувствительности
- Кнопки быстрой настройки (Низкая, Средняя, Высокая, Макс.)
- Ползунок для точной настройки (диапазон 0-50)
- Числовое поле для ввода точного значения
- Автоматическое обновление значений каждые 5 секунд

**JavaScript функции:**
- `updateSensitivityDisplay()` - Обновление отображаемых значений
- `setSensitivity(level)` - Установка предустановленного уровня
- `applyCustomThreshold()` - Применение пользовательского значения
- `updateThresholdDisplay()` / `updateThresholdSlider()` - Синхронизация ползунка и поля ввода

#### 4. Документация

**Созданные файлы:**

- `SENSITIVITY_GUIDE.md` - Полное руководство по настройке чувствительности
  - Описание принципов работы
  - Рекомендации по настройке для разных сценариев
  - Примеры использования API
  - Советы по оптимизации

- `examples/sensitivity_examples.py` - Примеры программного использования
  - 9 готовых сценариев настройки
  - Примеры для помещений, улицы, ночной съемки
  - Интерактивные тесты разных уровней
  - Функции мониторинга

### Технические детали

**Изменённые файлы:**
1. `motion_detector.py` - Добавлены методы управления чувствительностью
2. `web_interface/app.py` - Добавлены API endpoints и import logging
3. `web_interface/templates/index.html` - Добавлена UI панель и JS функции
4. `README.md` - Обновлено описание возможностей

**Новые файлы:**
1. `SENSITIVITY_GUIDE.md` - Руководство пользователя
2. `examples/sensitivity_examples.py` - Примеры использования
3. `CHANGELOG_SENSITIVITY.md` - Этот файл

### Обратная совместимость

- ✅ Полная обратная совместимость с существующим кодом
- ✅ Старые настройки `threshold` в config.json продолжают работать
- ✅ Метод `update_threshold()` сохранён и работает как раньше
- ✅ Новые методы добавлены без изменения существующего API

### Требования

- Python 3.7+
- Flask (уже в зависимостях)
- Никаких дополнительных пакетов не требуется

### Использование

#### Через веб-интерфейс:
1. Откройте http://IP:5000
2. Найдите панель "Чувствительность детектора"
3. Выберите уровень или настройте точно ползунком

#### Через API:
```bash
# Получить текущее значение
curl http://IP:5000/api/motion/sensitivity

# Установить высокую чувствительность
curl -X POST http://IP:5000/api/motion/sensitivity \
  -H "Content-Type: application/json" \
  -d '{"sensitivity": "high"}'

# Установить точное значение
curl -X POST http://IP:5000/api/motion/threshold \
  -H "Content-Type: application/json" \
  -d '{"threshold": 5.5}'
```

#### В коде Python:
```python
# Через объект motion_detector
detector.set_sensitivity('high')
detector.update_threshold(5.5)
current = detector.get_sensitivity_level()
```

### Примеры сценариев

**Для помещения:**
- Начните с 'medium'
- При ложных срабатываниях → 'low'
- При пропуске событий → 'high'

**Для улицы:**
- Используйте 'low' или threshold 10-15
- Учитывайте изменчивое освещение

**Ночная съемка:**
- Рекомендуется 'low' или threshold 10-15
- Компенсация шума матрицы

### Решённые задачи

- ✅ Гибкая настройка чувствительности через веб-интерфейс
- ✅ Предустановленные уровни для быстрой настройки
- ✅ Точная настройка для опытных пользователей
- ✅ Автоматическое сохранение настроек
- ✅ Полная документация и примеры
- ✅ API для программного управления

### Известные ограничения

- Чувствительность применяется ко всем зонам одновременно
- Нельзя установить разную чувствительность для разных зон
- Диапазон threshold ограничен 0-50 (программно)

### Будущие улучшения

Возможные направления развития:
- Индивидуальная чувствительность для каждой зоны
- Автоматическая калибровка на основе условий освещения
- Адаптивная чувствительность по времени суток
- История изменений чувствительности
- Рекомендации на основе статистики ложных срабатываний

### Миграция

Для существующих установок не требуется никаких действий. Новая функциональность доступна сразу после обновления файлов.

### Тестирование

Протестировано на:
- Raspberry Pi 4 Model B (4GB)
- Camera Module 3
- Raspberry Pi OS 64-bit Bookworm
- Python 3.11

### Авторы

- Реализовано: Claude Code
- Дата: 2026-02-16
