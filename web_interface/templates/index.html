<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RasCam - –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #4CAF50;
            font-size: 24px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stream-container {
            background: #000;
            border-radius: 4px;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            position: relative;
            overflow: hidden;
        }

        .stream-placeholder {
            text-align: center;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-unit {
            font-size: 14px;
            color: #888;
            margin-left: 4px;
        }

        .recordings-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .recording-item {
            background: #1a1a1a;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recording-info {
            flex: 1;
        }

        .recording-filename {
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .recording-meta {
            color: #888;
            font-size: 12px;
        }

        .recording-actions {
            display: flex;
            gap: 8px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        button.secondary {
            background: #555;
        }

        button.secondary:hover {
            background: #666;
        }

        .zones-list {
            margin-top: 15px;
        }

        .zone-item {
            background: #1a1a1a;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zone-name {
            font-weight: bold;
            color: #4CAF50;
        }

        .zone-coords {
            color: #888;
            font-size: 12px;
        }

        .temp-chart {
            height: 150px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-top: 15px;
            padding: 10px;
            position: relative;
        }

        .loading {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .rtsp-info {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .rtsp-url {
            font-family: monospace;
            background: #000;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            word-break: break-all;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            border-radius: 24px;
            transition: .4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="grid">
            <div class="card">
                <h2>–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫</h2>
                <div class="stream-container" id="streamContainer">
                    <div class="stream-placeholder">
                        <p>RTSP Stream –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
                        <p style="font-size: 12px; margin-top: 8px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VLC –∏–ª–∏ –¥—Ä—É–≥–æ–π RTSP –∫–ª–∏–µ–Ω—Ç</p>
                    </div>
                    <canvas id="zoneCanvas"></canvas>
                </div>
                <div style="margin-top: 15px;">
                    <h2 style="font-size: 18px; color: #4CAF50; margin-bottom: 10px;">–ó–æ–Ω—ã –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è</h2>
                    <p style="color: #888; font-size: 14px; margin-bottom: 10px;">
                        –ù–∞—Ä–∏—Å—É–π—Ç–µ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –Ω–∞ –≤–∏–¥–µ–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–æ–Ω—ã
                    </p>
                    <div class="zones-list" id="zonesList">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–æ–Ω...</div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2 style="display: flex; justify-content: space-between; align-items: center;">
                        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: normal;">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ CPU</div>
                            <div class="stat-value">
                                <span id="tempValue">--</span>
                                <span class="stat-unit">¬∞C</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏</div>
                            <div class="stat-value" style="font-size: 16px;" id="recStatus">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">–§–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ</div>
                            <div class="stat-value" id="recCount">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –º–µ—Å—Ç–∞</div>
                            <div class="stat-value">
                                <span id="storageUsage">0</span>
                                <span class="stat-unit">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="temp-chart" id="tempChart">
                        <canvas id="tempCanvas" width="100" height="130"></canvas>
                    </div>

                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ -->
                    <div style="margin-top: 15px; padding: 15px; background: #1a1a1a; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #4CAF50;">–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å</strong>
                                <p style="color: #888; font-size: 12px; margin-top: 4px;">24/7 –∑–∞–ø–∏—Å—å –≤–º–µ—Å—Ç–æ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è</p>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="continuousRecToggle" onchange="toggleContinuousRecording()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –¥–≤–∏–∂–µ–Ω–∏—è -->
                    <div style="margin-top: 15px; padding: 15px; background: #1a1a1a; border-radius: 4px;">
                        <strong style="color: #4CAF50;">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞</strong>
                        <p style="color: #888; font-size: 12px; margin-top: 4px; margin-bottom: 12px;">
                            –¢–µ–∫—É—â–∏–π –ø–æ—Ä–æ–≥: <span id="currentThreshold">--</span> (<span id="currentSensitivity">--</span>)
                        </p>

                        <!-- –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ -->
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
                            <button class="secondary" onclick="setSensitivity('low')">–ù–∏–∑–∫–∞—è</button>
                            <button class="secondary" onclick="setSensitivity('medium')">–°—Ä–µ–¥–Ω—è—è</button>
                            <button class="secondary" onclick="setSensitivity('high')">–í—ã—Å–æ–∫–∞—è</button>
                            <button class="secondary" onclick="setSensitivity('very_high')">–ú–∞–∫—Å.</button>
                        </div>

                        <!-- –¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ -->
                        <div style="margin-top: 10px;">
                            <label style="color: #888; font-size: 12px; display: block; margin-bottom: 5px;">
                                –¢–æ—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (0-50):
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input
                                    type="range"
                                    id="thresholdSlider"
                                    min="0"
                                    max="50"
                                    step="0.5"
                                    value="7"
                                    style="flex: 1; cursor: pointer;"
                                    oninput="updateThresholdDisplay()"
                                >
                                <input
                                    type="number"
                                    id="thresholdInput"
                                    min="0"
                                    max="50"
                                    step="0.5"
                                    value="7"
                                    style="width: 60px; padding: 4px 8px; background: #000; color: #e0e0e0; border: 1px solid #555; border-radius: 4px;"
                                    oninput="updateThresholdSlider()"
                                >
                                <button onclick="applyCustomThreshold()" style="padding: 4px 12px;">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>RTSP URL</h2>
                <div class="rtsp-info" style="margin-top: 0;">
                    <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</strong>
                    <div class="rtsp-url" id="rtspUrl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <p style="color: #888; font-size: 12px; margin-top: 8px;">
                        –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç URL –≤ VLC (Media ‚Üí Open Network Stream)
                    </p>
                </div>
            </div>

            <div class="card">
                <h2>–ó–∞–ø–∏—Å–∏</h2>
                <div class="recordings-list" id="recordingsList">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        let updateInterval;
        let tempHistory = [];

        function updateStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    // –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');

                    if (data.running) {
                        statusDot.style.background = '#4CAF50';
                        statusText.textContent = '–ê–∫—Ç–∏–≤–Ω–æ';
                    } else {
                        statusDot.style.background = '#f44336';
                        statusText.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    }

                    // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
                    if (data.thermal) {
                        document.getElementById('tempValue').textContent = data.thermal.current_temp;
                        tempHistory.push(data.thermal.current_temp);
                        if (tempHistory.length > 30) tempHistory.shift();
                        drawTempChart();
                    }

                    // –ó–∞–ø–∏—Å—å
                    if (data.recorder) {
                        const recStatus = document.getElementById('recStatus');
                        if (data.recorder.is_recording) {
                            recStatus.textContent = '–ó–∞–ø–∏—Å—å';
                            recStatus.style.color = '#f44336';
                        } else {
                            recStatus.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ';
                            recStatus.style.color = '#4CAF50';
                        }

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ
                        if (data.recorder.storage && data.recorder.storage.recordings_count !== undefined) {
                            document.getElementById('recCount').textContent = data.recorder.storage.recordings_count;
                        } else {
                            document.getElementById('recCount').textContent = data.recorder.total_recordings;
                        }

                        if (data.recorder.storage) {
                            document.getElementById('storageUsage').textContent =
                                data.recorder.storage.usage_percent || 0;
                        }

                        // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏
                        if (data.recorder.continuous_recording !== undefined) {
                            document.getElementById('continuousRecToggle').checked = data.recorder.continuous_recording;
                        }
                    }
                })
                .catch(err => console.error('Error fetching status:', err));
        }

        function updateRtspUrl() {
            fetch('/api/rtsp')
                .then(res => res.json())
                .then(data => {
                    if (data.rtsp_url) {
                        document.getElementById('rtspUrl').textContent = data.rtsp_url;
                    }
                })
                .catch(err => {
                    console.error('Error fetching RTSP URL:', err);
                    document.getElementById('rtspUrl').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ URL';
                });
        }

        function updateRecordings() {
            fetch('/api/recordings')
                .then(res => res.json())
                .then(recordings => {
                    const list = document.getElementById('recordingsList');

                    if (recordings.length === 0) {
                        list.innerHTML = '<div class="loading">–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                        return;
                    }

                    list.innerHTML = recordings.map(rec => {
                        const duration = rec.duration ? formatDuration(rec.duration) : '--:--';
                        return `
                            <div class="recording-item">
                                <div class="recording-info">
                                    <div class="recording-filename">${rec.filename}</div>
                                    <div class="recording-meta">${rec.size_mb} MB ¬∑ ${duration} ¬∑ ${new Date(rec.created).toLocaleString('ru-RU')}</div>
                                </div>
                                <div class="recording-actions">
                                    <button class="secondary" onclick="playRecording('${rec.filename}')">‚ñ∂</button>
                                    <button class="danger" onclick="deleteRecording('${rec.filename}')">üóë</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => console.error('Error fetching recordings:', err));
        }

        function updateZones() {
            fetch('/api/zones')
                .then(res => res.json())
                .then(zones => {
                    const list = document.getElementById('zonesList');

                    if (zones.length === 0) {
                        list.innerHTML = '<div class="loading">–ó–æ–Ω –Ω–µ—Ç</div>';
                        return;
                    }

                    list.innerHTML = zones.map(zone => `
                        <div class="zone-item">
                            <div>
                                <div class="zone-name">${zone.name}</div>
                                <div class="zone-coords">(${zone.x}, ${zone.y}) ${zone.width}√ó${zone.height}</div>
                            </div>
                            <div class="recording-actions">
                                <button class="secondary" onclick="toggleZone('${zone.name}', ${!zone.enabled})">
                                    ${zone.enabled ? '–í—ã–∫–ª' : '–í–∫–ª'}
                                </button>
                                <button class="danger" onclick="deleteZone('${zone.name}')">üóë</button>
                            </div>
                        </div>
                    `).join('');

                    drawZones(zones);
                })
                .catch(err => console.error('Error fetching zones:', err));
        }

        function drawZones(zones) {
            const canvas = document.getElementById('zoneCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            zones.forEach(zone => {
                if (!zone.enabled) return;

                // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (320x240 -> canvas size)
                const scaleX = canvas.width / 320;
                const scaleY = canvas.height / 240;

                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    zone.x * scaleX,
                    zone.y * scaleY,
                    zone.width * scaleX,
                    zone.height * scaleY
                );

                ctx.fillStyle = 'rgba(76, 175, 80, 0.2)';
                ctx.fillRect(
                    zone.x * scaleX,
                    zone.y * scaleY,
                    zone.width * scaleX,
                    zone.height * scaleY
                );

                ctx.fillStyle = '#4CAF50';
                ctx.font = '12px sans-serif';
                ctx.fillText(zone.name, zone.x * scaleX + 5, zone.y * scaleY + 15);
            });
        }

        function drawTempChart() {
            const canvas = document.getElementById('tempCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth;
            canvas.height = 130;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (tempHistory.length < 2) return;

            const max = Math.max(...tempHistory, 80);
            const min = Math.min(...tempHistory, 30);
            const range = max - min;

            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.beginPath();

            tempHistory.forEach((temp, i) => {
                const x = (i / (tempHistory.length - 1)) * canvas.width;
                const y = canvas.height - ((temp - min) / range) * canvas.height;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –ª–∏–Ω–∏–∏
            ctx.strokeStyle = '#f44336';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            const warningY = canvas.height - ((70 - min) / range) * canvas.height;
            ctx.beginPath();
            ctx.moveTo(0, warningY);
            ctx.lineTo(canvas.width, warningY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function playRecording(filename) {
            window.open(`/api/recording/${filename}`, '_blank');
        }

        function deleteRecording(filename) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ${filename}?`)) return;

            fetch(`/api/recording/${filename}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateRecordings();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                });
        }

        function deleteZone(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–æ–Ω—É ${name}?`)) return;

            fetch(`/api/zones/${name}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateZones();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–æ–Ω—ã');
                    }
                });
        }

        function toggleZone(name, enabled) {
            fetch(`/api/zones/${name}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateZones();
                    }
                });
        }

        function toggleContinuousRecording() {
            const enabled = document.getElementById('continuousRecToggle').checked;

            fetch('/api/recording/continuous', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∑–∞–ø–∏—Å—å: ${enabled ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞'}`);
                        updateStatus();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –∑–∞–ø–∏—Å–∏');
                        // –í–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–Ω–æ
                        document.getElementById('continuousRecToggle').checked = !enabled;
                    }
                })
                .catch(err => {
                    console.error('Error toggling continuous recording:', err);
                    alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    // –í–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –æ–±—Ä–∞—Ç–Ω–æ
                    document.getElementById('continuousRecToggle').checked = !enabled;
                });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∑–æ–Ω –º—ã—à—å—é
        let isDrawing = false;
        let startX, startY;
        let drawingZone = null;

        function initZoneDrawing() {
            const canvas = document.getElementById('zoneCanvas');
            const rect = canvas.getBoundingClientRect();

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;

                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ –∑–æ–Ω—ã
                updateZones();

                // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.strokeRect(
                    startX,
                    startY,
                    currentX - startX,
                    currentY - startY
                );
                ctx.setLineDash([]);
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!isDrawing) return;
                isDrawing = false;

                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;

                // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–æ–Ω—ã
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);

                if (width < 20 || height < 20) {
                    console.log('–ó–æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è (–º–∏–Ω–∏–º—É–º 20x20 –ø–∏–∫—Å–µ–ª–µ–π)');
                    return;
                }

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã canvas –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã low-res –∫–∞–¥—Ä–∞ (320x240)
                const scaleX = 320 / canvas.width;
                const scaleY = 240 / canvas.height;

                const x = Math.round(Math.min(startX, currentX) * scaleX);
                const y = Math.round(Math.min(startY, currentY) * scaleY);
                const w = Math.round(width * scaleX);
                const h = Math.round(height * scaleY);

                // –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∏–º—è –∑–æ–Ω—ã
                const zoneName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –Ω–æ–≤–æ–π –∑–æ–Ω—ã:', `zone_${Date.now()}`);
                if (!zoneName) return;

                // –°–æ–∑–¥–∞—Ç—å –∑–æ–Ω—É —á–µ—Ä–µ–∑ API
                createZone(zoneName, x, y, w, h);
            });

            // –û–±–Ω–æ–≤–∏—Ç—å rect –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                const newRect = canvas.getBoundingClientRect();
                Object.assign(rect, newRect);
            });
        }

        function createZone(name, x, y, width, height) {
            fetch('/api/zones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, x, y, width, height })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log(`–ó–æ–Ω–∞ '${name}' —Å–æ–∑–¥–∞–Ω–∞`);
                        updateZones();
                    } else {
                        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–æ–Ω—ã: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    }
                })
                .catch(err => {
                    console.error('Error creating zone:', err);
                    alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                });
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
        function updateSensitivityDisplay() {
            fetch('/api/motion/sensitivity')
                .then(res => res.json())
                .then(data => {
                    if (data.threshold !== undefined) {
                        document.getElementById('currentThreshold').textContent = data.threshold.toFixed(1);
                        document.getElementById('currentSensitivity').textContent = getSensitivityLabel(data.sensitivity);
                        document.getElementById('thresholdSlider').value = data.threshold;
                        document.getElementById('thresholdInput').value = data.threshold;
                    }
                })
                .catch(err => console.error('Error fetching sensitivity:', err));
        }

        function getSensitivityLabel(level) {
            const labels = {
                'low': '–Ω–∏–∑–∫–∞—è',
                'medium': '—Å—Ä–µ–¥–Ω—è—è',
                'high': '–≤—ã—Å–æ–∫–∞—è',
                'very_high': '–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è'
            };
            return labels[level] || level;
        }

        function setSensitivity(level) {
            fetch('/api/motion/sensitivity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sensitivity: level })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateSensitivityDisplay();
                        console.log(`–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${level}`);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏');
                    }
                })
                .catch(err => {
                    console.error('Error setting sensitivity:', err);
                    alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                });
        }

        function updateThresholdDisplay() {
            const value = document.getElementById('thresholdSlider').value;
            document.getElementById('thresholdInput').value = value;
        }

        function updateThresholdSlider() {
            const value = document.getElementById('thresholdInput').value;
            document.getElementById('thresholdSlider').value = value;
        }

        function applyCustomThreshold() {
            const threshold = parseFloat(document.getElementById('thresholdInput').value);

            if (isNaN(threshold) || threshold < 0 || threshold > 50) {
                alert('–ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 50');
                return;
            }

            fetch('/api/motion/threshold', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threshold })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        updateSensitivityDisplay();
                        console.log(`–ü–æ—Ä–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${threshold}`);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ä–æ–≥–∞');
                    }
                })
                .catch(err => {
                    console.error('Error setting threshold:', err);
                    alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStatus();
        updateRecordings();
        updateZones();
        updateRtspUrl();
        updateSensitivityDisplay();
        initZoneDrawing();

        updateInterval = setInterval(() => {
            updateStatus();
            updateRecordings();
        }, 2000);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–æ–Ω –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(updateZones, 10000);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(updateSensitivityDisplay, 5000);
    </script>
</body>
</html>
