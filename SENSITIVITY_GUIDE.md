# Руководство по настройке чувствительности детектора движения

## Обзор

RasCam теперь поддерживает гибкую настройку чувствительности детектора движения через веб-интерфейс и API. Чувствительность определяет, насколько легко детектор реагирует на изменения в кадре.

## Параметры чувствительности

### Как это работает

Детектор использует алгоритм MSE (Mean Squared Error) для анализа изменений между кадрами. Параметр `threshold` определяет минимальное значение MSE, при котором движение считается обнаруженным:

- **Низкий threshold (высокая чувствительность)**: Детектор реагирует даже на небольшие изменения
- **Высокий threshold (низкая чувствительность)**: Детектор реагирует только на значительные изменения

### Предустановленные уровни

| Уровень | Threshold | Описание |
|---------|-----------|----------|
| **Низкая** (low) | 15.0 | Реагирует только на крупные объекты и значительные движения |
| **Средняя** (medium) | 7.0 | Баланс между точностью и ложными срабатываниями (по умолчанию) |
| **Высокая** (high) | 4.0 | Чувствителен к мелким движениям |
| **Максимальная** (very_high) | 2.0 | Максимальная чувствительность, может давать ложные срабатывания |

## Управление через веб-интерфейс

### Быстрая настройка

1. Откройте веб-интерфейс RasCam (http://IP:5000)
2. В правой панели найдите секцию "Чувствительность детектора"
3. Нажмите на одну из кнопок предустановленных уровней:
   - **Низкая**: Для минимизации ложных срабатываний
   - **Средняя**: Рекомендуемая настройка
   - **Высокая**: Для обнаружения мелких объектов
   - **Макс.**: Максимальная чувствительность

### Точная настройка

Для более детальной настройки используйте ползунок и числовое поле:

1. Переместите ползунок или введите значение от 0 до 50
2. Нажмите кнопку "OK" для применения
3. Текущий порог и уровень отображаются в реальном времени

**Рекомендации по значениям:**
- `0-3`: Очень высокая чувствительность, много ложных срабатываний
- `4-8`: Оптимальный диапазон для большинства сценариев
- `9-15`: Пониженная чувствительность, для шумных сред
- `16+`: Очень низкая чувствительность, только крупные объекты

## Управление через API

### Получить текущую чувствительность

```bash
curl http://IP:5000/api/motion/sensitivity
```

Ответ:
```json
{
  "sensitivity": "medium",
  "threshold": 7.0
}
```

### Установить предустановленный уровень

```bash
curl -X POST http://IP:5000/api/motion/sensitivity \
  -H "Content-Type: application/json" \
  -d '{"sensitivity": "high"}'
```

Возможные значения: `low`, `medium`, `high`, `very_high`

### Установить точное значение порога

```bash
curl -X POST http://IP:5000/api/motion/threshold \
  -H "Content-Type: application/json" \
  -d '{"threshold": 5.5}'
```

Диапазон: 0.0 - 50.0

## Программное использование

### В коде Python

```python
# Получить доступ к детектору движения
motion_detector = surveillance_system.motion_detector

# Установить предустановленный уровень
motion_detector.set_sensitivity('high')

# Установить точное значение порога
motion_detector.update_threshold(5.5)

# Получить текущий уровень
current_level = motion_detector.get_sensitivity_level()
print(f"Текущая чувствительность: {current_level}")

# Получить точное значение порога
print(f"Порог: {motion_detector.threshold}")
```

## Сохранение настроек

Все изменения чувствительности автоматически сохраняются в `config.json`:

```json
{
  "motion_detection": {
    "threshold": 7.0,
    ...
  }
}
```

При перезапуске системы настройки чувствительности восстанавливаются автоматически.

## Советы по настройке

### Для помещений
- Начните с уровня "Средняя"
- При частых ложных срабатываниях (тени, свет) - снизьте до "Низкая"
- При пропуске событий - повысьте до "Высокая"

### Для улицы
- Используйте "Низкая" или "Средняя" из-за изменчивого освещения
- При наличии деревьев/веток на ветру - понизьте чувствительность
- Настройте зоны детекции, исключив проблемные области

### Ночная съемка
- Обычно требуется пониженная чувствительность
- Шум матрицы может вызывать ложные срабатывания
- Рекомендуется threshold 10-15

### Оптимизация производительности
- Высокая чувствительность → больше записей → больше нагрузка на CPU/диск
- Используйте минимально необходимую чувствительность
- Комбинируйте с параметром `min_frames` для фильтрации кратковременных событий

## Интеграция с зонами детекции

Чувствительность применяется ко всем зонам детекции одновременно. Для разной чувствительности в разных областях кадра:

1. Создайте несколько зон
2. Используйте среднее значение чувствительности
3. Включайте/выключайте зоны по необходимости

## Мониторинг и диагностика

Статус детектора движения доступен через API:

```bash
curl http://IP:5000/api/status
```

Смотрите секцию `motion`:
```json
{
  "motion": {
    "threshold": 7.0,
    "sensitivity": "medium",
    "motion_frames": 0,
    "zones_count": 1
  }
}
```

## Решение проблем

### Слишком много ложных срабатываний
- Увеличьте threshold (понизьте чувствительность)
- Увеличьте `min_frames` в config.json
- Настройте зоны детекции, исключив проблемные области

### Пропуск реальных событий
- Уменьшите threshold (повысьте чувствительность)
- Проверьте настройки зон детекции
- Убедитесь, что движение происходит в активных зонах

### Нестабильная работа
- Используйте предустановленные уровни вместо крайних значений
- Проверьте освещение и качество изображения
- Убедитесь, что камера надежно закреплена (вибрация вызывает ложные срабатывания)
